<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>io</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="./vue.js"></script>
</head>
<body>
<div id="app">
    <button @click="addRoom()">addRoom</button>
    <button @click="addRecord()">集中</button>

    <li v-for="(item, key) in rooms" :key="item.id">
        <span> ({{ item.name }})</span>

        <button @click="join(item)">加入</button>
        <button @click="delRoom(item.id)">删除</button>
    </li>
    <hr>
    <div v-if="currentRoom">
        <div> 房间号: {{ currentRoom }}</div>
        <li v-for="item in currentRoomUsers">
            {{ userMap[item.id] }}
            <strong>{{ stat[item.id] }}</strong>
        </li>
    </div>

    <div v-if="currentRoom">
        <div> 历史</div>
        <li v-for="item in currentRoomRecords">
            {{ userMap[item.from] }} -->

            <span v-for="(it, idx) in item.to">{{ userMap[it] }} {{ item.toValue[idx] }}元</span>、
        </li>
    </div>
</div>

<script>
    let userId = localStorage.getItem('userId')
    if (!userId) {
        userId = `${Date.now()}-user-${Math.random()}`.replace('.', '')
        localStorage.setItem('userId', userId)
    }
    let socket = io();

    vm = new Vue({
        el: '#app',
        data() {
            return {
                rooms: [],
                users: [],
                records: [],
                currentRoom: '',
                id: ''
            }
        },
        computed: {
            currentRoomUsers() {
                return this.users.filter(item => item.roomId === this.currentRoom)
            },
            currentRoomRecords() {
                return this.records.filter(item => item.roomId === this.currentRoom).map(item => {
                    let from = 'none'
                    let fromValue = 0
                    let to = []
                    let toValue = []
                    Object.keys(item).forEach(key => {
                        if (key.includes('-user-')) {
                            const value = item[key]
                            if (value < 0) {
                                from = key
                                fromValue = value
                            } else {
                                to.push(key)
                                toValue.push(value)
                            }
                        }
                    })

                    return {
                        from,
                        fromValue,
                        to,
                        toValue
                    }
                })
            },
            userMap() {
                const result = {}
                this.users.forEach(item => {
                    result[item.id] = item.name
                })
                return result
            },
            stat() {
                const result = {}
                this.users.forEach(user => {
                    let count = 0
                    this.records.forEach(item => {
                        count += (item[user.id] || 0)
                    })
                    result[user.id] = count
                })
                return result
            }
        },
        created() {
            socket.on('rooms', rooms => {
                console.log('rooms', rooms)
                this.rooms = rooms
            })

            socket.on('records', records => {
                console.log('records', records)
                this.records = records
            })

            socket.on('users', users => {
                console.log('users', users)
                this.users = users
            })
        },
        methods: {
            addRoom() {
                socket.emit('add-room', {name: '房间' + Date.now()});
            },
            addRecord() {
                socket.emit('add-record', {
                    roomId: this.currentRoom,
                    "1693415025180-user-09218579040849937": -1,
                    "1693415040759-user-016372864506026197": +1,
                });
            },
            delRoom(id) {
                socket.emit('del-room', id);
            },

            join(room) {
                socket.emit('join', room, {id: userId, name: '张三'});
                this.currentRoom = room.id
            },

            leave(room) {
                socket.emit('leave', room);
            }
        }
    })
</script>
</body>
</html>