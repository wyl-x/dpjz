<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>io</title>
    <script src="https://cdn.socket.io/2.0.4/socket.io.min.js"></script>
    <script src="./vue.js"></script>
    <link rel="stylesheet" href="./pub.css">
</head>
<body>
<div id="app">
    <input type="text" @blur="storeUserName" v-model="userName">

    <button @click="addRoom()">addRoom</button>

    <li v-for="(item, key) in rooms" :key="item.id">
        <span> {{ item.name }}</span>

        <button @click="join(item.id)">加入</button>
        <button @click="delRoom(item.id)">删除</button>
    </li>
    <hr>
    <div v-if="currentRoom">
        <div> 房间号: {{ currentRoom }}</div>
        <li v-for="item in currentRoomUsers" :key="item.id">
            {{ userMap[item.id] }}
            <strong>{{ stat[item.id] }}</strong>

            <template v-if="userId !== item.id">
                <button @click="sendTo(item.id, 1)">+1</button>
                <button @click="sendTo(item.id, 2)">+2</button>
            </template>
        </li>
    </div>

    <div v-if="currentRoom">
        <div>历史</div>
        <li v-for="item in currentRoomRecords" :key="item.id">
            {{ userMap[item.from] }} -->

            <span v-for="(it, idx) in item.to">
                <span v-if="idx">、</span>
                {{ userMap[it] }} {{ item.toValue[idx] }}
            </span>
        </li>
    </div>
</div>

<script>
    let userId = localStorage.getItem('userId')
    let userName = localStorage.getItem('userName')
    let currentRoom = localStorage.getItem('currentRoom')
    if (!userId) {
        userId = `${Date.now()}-user-${Math.random()}`.replace('.', '')
        localStorage.setItem('userId', userId)
    }
    let socket;

    vm = new Vue({
        el: '#app',
        created() {
            socket = io("http://81.68.145.84:3000");
            console.log(socket, "socket");

            socket.on("rooms", (rooms) => {
                console.log("rooms", rooms);
                this.rooms = rooms;
            });

            socket.on("records", (records) => {
                console.log("records", records);
                this.records = records;
            });

            socket.on("users", (users) => {
                console.log("users", users);
                this.users = users;
            });
        },
        data() {
            return {
                items: [1, 2, 4, 8],
                rooms: [],
                users: [],
                records: [],
                currentRoom,
                userName,
                userId,
            };
        },
        computed: {
            currentRoomUsers() {
                return this.users.filter((item) => item.roomId === this.currentRoom);
            },
            currentRoomRecords() {
                return this.records
                    .filter((item) => item.roomId === this.currentRoom)
                    .map((item) => {
                        let from = "none";
                        let fromValue = 0;
                        let to = [];
                        let toValue = [];
                        Object.keys(item).forEach((key) => {
                            if (key.includes("-user-")) {
                                const value = item[key];
                                if (value < 0) {
                                    from = key;
                                    fromValue = value;
                                } else {
                                    to.push(key);
                                    toValue.push(value);
                                }
                            }
                        });

                        return {
                            time: dayjs(+item.id).format("MM-DD HH:mm:ss"),
                            from,
                            fromValue,
                            to,
                            toValue,
                        };
                    })
                    .reverse();
            },
            userMap() {
                const result = {};
                this.users.forEach((item) => {
                    result[item.id] = item.name;
                });
                return result;
            },
            stat() {
                const result = {};
                this.users.forEach((user) => {
                    let count = 0;
                    this.records
                        .filter((item) => item.roomId === this.currentRoom)
                        .forEach((item) => {
                            count += item[user.id] || 0;
                        });
                    result[user.id] = count;
                });
                return result;
            },
        },

        methods: {
            storeUserName() {
                localStorage.setItem("userName", this.userName);
            },
            addRoom() {
                socket.emit("add-room", { name: "房间" + Date.now() });
            },
            sendTo(user, value) {
                if (user === userId) {
                    return;
                }
                socket.emit("add-record", {
                    roomId: this.currentRoom,
                    [userId]: -1 * value,
                    [user]: value,
                });
            },
            delRoom(id) {
                socket.emit("del-room", id);
            },

            join(roomId) {
                socket.emit("join", roomId, { id: userId, name: this.userName });
                localStorage.setItem("currentRoom", roomId);
                this.currentRoom = roomId;
            },

            leave(room) {
                socket.emit("leave", room);
            },
        },
    })
</script>
</body>
</html>